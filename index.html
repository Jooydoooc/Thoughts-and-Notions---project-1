<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reading Platform</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto+Slab:wght@300;400;500&display=swap" rel="stylesheet" />
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --accent: #4cc9f0;
            --success: #4ade80;
            --warning: #f59e0b;
            --danger: #ef4444;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --border-radius: 16px;
            --shadow: 0 10px 40px rgba(0,0,0,0.1);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            min-height: 100vh;
            color: var(--dark);
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

        /* Login Page */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 50px 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 500px;
            animation: slideUp 0.6s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-card h1 {
            text-align: center;
            color: var(--secondary);
            margin-bottom: 40px;
            font-size: 2.8rem;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo { text-align: center; margin-bottom: 40px; }

        .logo-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            color: var(--primary);
            display: inline-block;
            padding: 20px;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 50%;
        }

        .form-group { margin-bottom: 30px; position: relative; }

        .form-group label {
            display: block;
            margin-bottom: 12px;
            color: var(--dark);
            font-weight: 600;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group label i { color: var(--primary); width: 20px; }

        .form-group input, .form-group select {
            width: 100%;
            padding: 18px 20px;
            border: 2px solid #e0e7ff;
            border-radius: 12px;
            font-size: 16px;
            transition: var(--transition);
            background: white;
            font-family: 'Poppins', sans-serif;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.15);
            transform: translateY(-2px);
        }

        .form-group input[readonly] { background: #f8fafc; color: var(--gray); }

        .btn {
            display: inline-block;
            padding: 18px 40px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            width: 100%;
            margin-top: 10px;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.7s ease;
        }

        .btn:hover { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(67, 97, 238, 0.4); }
        .btn:hover::after { left: 100%; }

        /* Main Platform */
        .platform-container { display: none; }

        .header {
            background: white;
            padding: 25px 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .header h1 {
            display: flex;
            align-items: center;
            gap: 15px;
            color: var(--secondary);
            font-size: 2rem;
        }

        .header h1 i { color: var(--primary); font-size: 2.5rem; }

        .user-info { display: flex; align-items: center; gap: 20px; }

        .user-avatar {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 24px;
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
        }

        .user-details h3 { color: var(--secondary); margin-bottom: 5px; font-size: 18px; }

        .user-details p {
            color: var(--gray);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logout-btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #ff6b6b, #ff4757);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .logout-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(255, 107, 107, 0.3); }

        /* Books Grid */
        .books-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 40px;
            margin-bottom: 50px;
        }

        .book-card {
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: var(--transition);
            cursor: pointer;
            position: relative;
        }

        .book-card:hover { transform: translateY(-15px); box-shadow: 0 25px 50px rgba(0,0,0,0.15); }

        .book-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
        }

        .book-cover {
            height: 220px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 4rem;
            position: relative;
            overflow: hidden;
        }

        .book-cover::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 100%);
        }

        .book-info { padding: 30px; }

        .book-info h3 { margin-bottom: 15px; color: var(--secondary); font-size: 1.8rem; }

        .book-info p { color: var(--gray); margin-bottom: 20px; line-height: 1.7; font-size: 15px; }

        .coming-soon { opacity: 0.8; }
        .coming-soon .book-cover { background: linear-gradient(135deg, #c3cfe2 0%, #a5b4fc 100%); }

        .status-badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 25px;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .available { background: linear-gradient(135deg, var(--success), #16a34a); color: white; }
        .soon { background: linear-gradient(135deg, var(--warning), #d97706); color: white; }

        /* Unit View */
        .unit-view { display: none; animation: slideIn 0.5s ease; }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
            border: none;
            color: var(--primary);
            font-size: 16px;
            cursor: pointer;
            padding: 15px 25px;
            margin-bottom: 30px;
            border-radius: 12px;
            transition: var(--transition);
            font-weight: 600;
        }

        .back-btn:hover { transform: translateX(-5px); background: linear-gradient(135deg, #e2e8f0, #cbd5e1); }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            border: 1px solid #e0e7ff;
        }

        .tab-btn {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            background: none;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
            color: var(--gray);
            font-weight: 600;
            position: relative;
            overflow: hidden;
        }

        .tab-btn:hover { background: #f8fafc; color: var(--primary); transform: translateY(-3px); }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 10px 25px rgba(67, 97, 238, 0.2);
        }

        .tab-btn.active .tab-icon { color: white; transform: scale(1.2); }
        .tab-icon { font-size: 28px; transition: var(--transition); color: var(--primary); }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 3px;
            background: white;
            border-radius: 2px;
        }

        /* Content Sections */
        .content-section { display: none; animation: fadeIn 0.5s ease; }
        .content-section.active { display: block; }

        /* Reading Section */
        .reading-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 40px;
            border: 1px solid #e0e7ff;
        }

        .reading-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f1f5f9;
        }

        .reading-header h2 {
            color: var(--secondary);
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .reading-header h2 i { color: var(--primary); }

        /* Compact Reading Controls */
        .reading-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: #f8fafc;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 2px solid #e0e7ff;
        }

        .control-row {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: white;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }

        .control-group label { font-weight: 600; color: var(--dark); font-size: 14px; white-space: nowrap; }

        .control-btn {
            padding: 12px 20px;
            background: white;
            border: 2px solid #e0e7ff;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            border-color: var(--primary);
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.1);
        }

        .control-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .control-btn.active i { color: white; }

        .speed-control { display: flex; align-items: center; gap: 10px; min-width: 180px; }

        .speed-control input {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            background: linear-gradient(to right, var(--primary), var(--accent));
            border-radius: 3px;
            outline: none;
        }

        .speed-control input::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            border: 2px solid var(--primary);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        #speedValue, #skimmingSpeedValue {
            font-weight: 700;
            color: var(--primary);
            min-width: 35px;
            text-align: center;
            font-size: 14px;
        }

        .voice-selection { min-width: 200px; }
        .voice-selection select {
            padding: 10px 15px;
            border: 1px solid #e0e7ff;
            border-radius: 8px;
            background: white;
            font-family: 'Poppins', sans-serif;
            font-size: 14px;
            width: 100%;
        }

        .reading-text {
            font-family: 'Roboto Slab', serif;
            font-size: 18px;
            line-height: 1.8;
            padding: 25px;
            background: #f8fafc;
            border-radius: var(--border-radius);
            border-left: 5px solid var(--primary);
            min-height: 300px;
            margin-bottom: 20px;
        }

        .text-line { margin-bottom: 20px; position: relative; padding-left: 15px; }
        .text-line::before { content: '‚Ä¢'; color: var(--primary); position: absolute; left: 0; font-size: 18px; }

        .skimming-active { opacity: 0.3; transition: opacity 0.3s ease; }

        /* Progress Bar */
        .progress-bar {
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 3px;
        }

        /* Vocabulary */
        .vocabulary-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 40px;
            border: 1px solid #e0e7ff;
        }

        .section-title { display: flex; align-items: center; gap: 15px; margin-bottom: 25px; color: var(--secondary); }
        .section-title i {
            font-size: 24px;
            color: var(--primary);
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .section-title h2 { font-size: 1.8rem; }

        .vocab-tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            border: 1px solid #e0e7ff;
        }

        .vocab-tab-btn {
            flex: 1;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: none;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            color: var(--gray);
            font-weight: 600;
            font-size: 14px;
            justify-content: center;
        }

        .vocab-tab-btn:hover { background: #f8fafc; color: var(--primary); }
        .vocab-tab-btn.active {
            background: linear-gradient(135deg, var(--accent), var(--primary));
            color: white;
            box-shadow: 0 5px 15px rgba(76, 201, 240, 0.2);
        }

        .vocab-tab-content { display: none; animation: fadeIn 0.5s ease; }
        .vocab-tab-content.active { display: block; }

        .vocabulary-grid, .collocations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .vocab-card {
            padding: 20px;
            background: white;
            border-radius: 12px;
            border: 2px solid #e0e7ff;
            transition: var(--transition);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .vocab-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 10px 20px rgba(67, 97, 238, 0.1);
        }

        .vocab-card.found {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border-color: var(--success);
        }

        .vocab-word-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .vocab-word { font-weight: 700; font-size: 18px; color: var(--secondary); }
        .vocab-pronunciation { font-size: 13px; color: var(--gray); font-style: italic; margin-top: 5px; }
        .vocab-type { font-size: 11px; padding: 4px 10px; background: var(--light); border-radius: 20px; color: var(--gray); font-weight: 600; }

        .pronunciation-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .pronunciation-btn:hover { background: var(--secondary); transform: scale(1.1); }

        .vocab-hint { font-size: 12px; color: var(--gray); font-style: italic; margin-bottom: 8px; display: none; }
        .vocab-card:hover .vocab-hint { display: block; }

        .vocab-translation { color: var(--primary); font-size: 15px; font-weight: 600; margin-bottom: 12px; display: none; }
        .vocab-definition { font-size: 14px; color: var(--dark); margin-bottom: 12px; line-height: 1.5; display: none; }
        .vocab-example {
            font-style: italic;
            color: var(--gray);
            font-size: 13px;
            border-left: 2px solid var(--accent);
            padding-left: 12px;
            margin-top: 12px;
            display: none;
        }

        .vocab-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }

        .stat {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border-radius: 12px;
            border: 2px solid #e0e7ff;
        }

        .stat-icon { font-size: 2rem; margin-bottom: 10px; color: var(--primary); }
        .stat-number { font-size: 2.2rem; font-weight: 800; color: var(--secondary); margin-bottom: 5px; line-height: 1; }
        .stat-label { color: var(--gray); font-size: 13px; font-weight: 600; }

        /* Grammar */
        .grammar-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 40px;
            border: 1px solid #e0e7ff;
        }

        .grammar-theme {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #bae6fd;
        }

        .grammar-theme h3 {
            color: var(--secondary);
            margin-bottom: 15px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .grammar-theme h3 i { color: var(--accent); }

        .grammar-explanation { font-size: 16px; line-height: 1.7; color: var(--dark); margin-bottom: 20px; }

        .grammar-examples { display: grid; gap: 15px; margin-bottom: 20px; }

        .grammar-example {
            padding: 15px;
            background: white;
            border-radius: 12px;
            border: 2px solid #e0e7ff;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .example-icon { color: var(--success); font-size: 1rem; flex-shrink: 0; margin-top: 3px; }

        /* Exercises */
        .exercises-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 40px;
            border: 1px solid #e0e7ff;
        }

        .exercise-category {
            margin-bottom: 40px;
            background: #f8fafc;
            padding: 25px;
            border-radius: 15px;
            border: 2px solid #e0e7ff;
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }

        .category-title { display: flex; align-items: center; gap: 15px; }

        .category-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }

        .category-info h3 { color: var(--secondary); margin-bottom: 5px; font-size: 1.3rem; }
        .category-info p { color: var(--gray); font-size: 13px; }

        .exercise-timer {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
            border: 2px solid #fbbf24;
            font-size: 14px;
        }

        .timer-warning { background: linear-gradient(135deg, #fecaca, #fca5a5); border-color: #ef4444; }
        .timer-critical { background: linear-gradient(135deg, #fee2e2, #fecaca); border-color: #dc2626; animation: pulse 1s infinite; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        .exercise-list { display: grid; gap: 25px; }

        .exercise-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #e0e7ff;
            transition: var(--transition);
            display: none;
        }

        .exercise-item.active { display: block; animation: slideIn 0.3s ease; }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .question-number { font-weight: 700; color: var(--primary); font-size: 16px; }

        .question-text {
            font-size: 16px;
            margin-bottom: 20px;
            color: var(--dark);
            font-weight: 500;
            line-height: 1.6;
        }

        .options-grid { display: grid; gap: 12px; }

        .option {
            padding: 15px 20px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 15px;
        }

        .option:hover { border-color: var(--primary); background: #f8fafc; }

        .option.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            color: var(--primary);
            font-weight: 600;
        }

        .option-letter {
            width: 30px;
            height: 30px;
            background: #f1f5f9;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--gray);
            flex-shrink: 0;
            font-size: 14px;
        }

        .option.selected .option-letter { background: var(--primary); color: white; }

        .option.correct { border-color: var(--success); background: linear-gradient(135deg, #f0fdf4, #dcfce7); }
        .option.incorrect { border-color: var(--danger); background: linear-gradient(135deg, #fef2f2, #fee2e2); }

        .exercise-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px solid #e2e8f0;
        }

        .nav-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .nav-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3); }
        .nav-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .progress-indicator { display: flex; gap: 4px; }

        .progress-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #e2e8f0;
            transition: var(--transition);
        }

        .progress-dot.active { background: var(--primary); transform: scale(1.2); }
        .progress-dot.answered { background: var(--success); }

        .exercise-result {
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
            align-items: center;
            justify-content: space-between;
            font-size: 14px;
        }

        .exercise-result.success { background: linear-gradient(135deg, #f0fdf4, #dcfce7); border: 2px solid var(--success); color: var(--dark); }
        .exercise-result.error { background: linear-gradient(135deg, #fef2f2, #fee2e2); border: 2px solid var(--danger); color: var(--dark); }

        .result-text { font-weight: 600; }

        .category-submit { width: 100%; padding: 15px; margin-top: 20px; font-size: 15px; border-radius: 10px; }

        /* Results Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            animation: modalSlide 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        @keyframes modalSlide {
            from { opacity: 0; transform: translateY(-40px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .modal-content::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 6px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
        }

        .result-score {
            font-size: 4rem;
            font-weight: 800;
            color: var(--primary);
            margin: 25px 0;
            text-shadow: 2px 2px 0 rgba(67, 97, 238, 0.1);
        }

        .result-message { font-size: 16px; color: var(--dark); margin: 25px 0; line-height: 1.6; }

        .grammar-submit { width: 100%; margin-top: 20px; }

        /* Responsive */
        @media (max-width: 1024px) {
            .control-row { flex-direction: column; align-items: stretch; }
            .control-group, .control-btn, .speed-control { width: 100%; justify-content: center; }
            .vocabulary-grid, .collocations-grid { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); }
        }

        @media (max-width: 768px) {
            .container { padding: 15px; }
            .login-card { padding: 30px 25px; }
            .header { flex-direction: column; gap: 20px; text-align: center; }
            .user-info { flex-direction: column; text-align: center; }
            .reading-header { flex-direction: column; gap: 20px; text-align: center; }
            .nav-tabs { flex-direction: column; gap: 8px; }
            .tab-btn { flex-direction: row; justify-content: flex-start; padding: 15px 20px; }
            .vocabulary-grid, .collocations-grid { grid-template-columns: 1fr; }
            .books-grid { grid-template-columns: 1fr; }
            .category-header { flex-direction: column; gap: 15px; align-items: flex-start; }
            .exercise-navigation { flex-direction: column; gap: 12px; }
            .nav-btn { width: 100%; justify-content: center; }
            .stat-number { font-size: 1.8rem; }
        }

        @media (max-width: 480px) {
            .login-card h1 { font-size: 2.2rem; }
            .reading-text { padding: 20px; font-size: 16px; }
            .section-title h2 { font-size: 1.5rem; }
            .vocab-tab-btn { padding: 12px 15px; font-size: 13px; }
            .exercise-timer { padding: 8px 15px; font-size: 13px; }
            .category-icon { width: 40px; height: 40px; font-size: 16px; }
        }
    </style>
</head>

<body>
    <!-- Login Page -->
    <div class="login-container" id="loginPage">
        <div class="login-card">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-book-reader"></i>
                </div>
                <h1>Reading Platform</h1>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="name"><i class="fas fa-user"></i> Name</label>
                    <input type="text" id="name" required placeholder="Enter your name" />
                </div>
                <div class="form-group">
                    <label for="surname"><i class="fas fa-users"></i> Surname</label>
                    <input type="text" id="surname" required placeholder="Enter your surname" />
                </div>
                <div class="form-group">
                    <label for="group"><i class="fas fa-layer-group"></i> Group</label>
                    <select id="group" required>
                        <option value="">Select Group</option>
                        <option value="Elementary 9:30">Elementary 9:30</option>
                        <option value="Brain Hackers">Brain Hackers</option>
                        <option value="Others">Others</option>
                    </select>
                </div>
                <div class="form-group" id="otherGroupContainer" style="display: none;">
                    <label for="otherGroup"><i class="fas fa-edit"></i> Specify Your Group</label>
                    <input type="text" id="otherGroup" placeholder="Enter your group name" />
                </div>
                <div class="form-group">
                    <label for="loginTime"><i class="fas fa-clock"></i> Login Time</label>
                    <input type="text" id="loginTime" readonly />
                </div>
                <button type="submit" class="btn">
                    <i class="fas fa-sign-in-alt"></i> Enter Platform
                </button>
            </form>
        </div>
    </div>

    <!-- Main Platform -->
    <div class="platform-container" id="platformContainer">
        <div class="container">
            <div class="header">
                <h1><i class="fas fa-book-open"></i> Reading Platform</h1>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div class="user-details">
                        <h3 id="userName"></h3>
                        <p><i class="fas fa-users"></i> <span id="userGroup"></span></p>
                    </div>
                    <button class="logout-btn" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>

            <!-- Books Grid -->
            <div id="booksSection">
                <h2 style="color: var(--secondary); margin-bottom: 30px; font-size: 2.2rem;">Available Books</h2>
                <div class="books-grid" id="booksGrid"></div>
            </div>

            <!-- Unit View -->
            <div class="unit-view" id="unitView">
                <button class="back-btn" id="backToBooksBtn">
                    <i class="fas fa-arrow-left"></i> Back to Books
                </button>

                <!-- Navigation Tabs -->
                <div class="nav-tabs">
                    <button class="tab-btn active" data-tab="reading">
                        <i class="fas fa-book-reader tab-icon"></i>
                        <span>Reading</span>
                    </button>
                    <button class="tab-btn" data-tab="vocabulary">
                        <i class="fas fa-graduation-cap tab-icon"></i>
                        <span>Vocabulary</span>
                    </button>
                    <button class="tab-btn" data-tab="grammar">
                        <i class="fas fa-language tab-icon"></i>
                        <span>Grammar</span>
                    </button>
                    <button class="tab-btn" data-tab="exercises">
                        <i class="fas fa-tasks tab-icon"></i>
                        <span>Exercises</span>
                    </button>
                </div>

                <!-- Reading Section -->
                <div class="content-section active" id="readingSection">
                    <div class="reading-section">
                        <div class="reading-header">
                            <h2><i class="fas fa-file-alt"></i> <span id="unitTitle">Unit 1.1 - The Zipper</span></h2>
                        </div>

                        <div class="reading-controls">
                            <div class="control-row">
                                <div class="control-group speed-control">
                                    <label><i class="fas fa-tachometer-alt"></i> Read Speed:</label>
                                    <input type="range" id="speedControl" min="1" max="9" step="1" value="5" />
                                    <span id="speedValue">5x</span>
                                </div>
                                <div class="control-group speed-control">
                                    <label><i class="fas fa-eye-slash"></i> Skim Speed:</label>
                                    <input type="range" id="skimmingSpeedControl" min="1" max="9" step="1" value="5" />
                                    <span id="skimmingSpeedValue">5x</span>
                                </div>
                            </div>

                            <div class="control-row">
                                <button class="control-btn" id="readAloudBtn">
                                    <i class="fas fa-volume-up"></i> Read Aloud
                                </button>
                                <button class="control-btn" id="skimmingBtn">
                                    <i class="fas fa-eye-slash"></i> Skimming
                                </button>
                                <div class="control-group voice-selection">
                                    <label><i class="fas fa-microphone"></i> Voice:</label>
                                    <select id="voiceSelect">
                                        <option value="">Select Voice</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="reading-text" id="readingText"></div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="skimmingProgress"></div>
                        </div>
                    </div>
                </div>

                <!-- Vocabulary Section -->
                <div class="content-section" id="vocabularySection">
                    <div class="vocabulary-section">
                        <div class="section-title">
                            <i class="fas fa-graduation-cap"></i>
                            <h2>Vocabulary & Collocations</h2>
                        </div>
                        <p style="color: var(--gray); margin-bottom: 20px; font-size: 14px;">
                            Click on each item to reveal details. Use the speaker button üîä to hear pronunciation!
                        </p>

                        <div class="vocab-tabs">
                            <button class="vocab-tab-btn active" data-vtab="vocabulary">
                                <i class="fas fa-book"></i> Vocabulary
                            </button>
                            <button class="vocab-tab-btn" data-vtab="collocations">
                                <i class="fas fa-link"></i> Collocations
                            </button>
                        </div>

                        <div class="vocab-tab-content active" id="vocabularyTab">
                            <div class="vocabulary-grid" id="vocabularyGrid"></div>
                        </div>

                        <div class="vocab-tab-content" id="collocationsTab">
                            <div class="collocations-grid" id="collocationsGrid"></div>
                        </div>

                        <div class="vocab-stats">
                            <div class="stat">
                                <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                                <div class="stat-number" id="foundCount">0</div>
                                <div class="stat-label">Items Found</div>
                            </div>
                            <div class="stat">
                                <div class="stat-icon"><i class="fas fa-book"></i></div>
                                <div class="stat-number" id="totalCount">0</div>
                                <div class="stat-label">Total Items</div>
                            </div>
                            <div class="stat">
                                <div class="stat-icon"><i class="fas fa-percentage"></i></div>
                                <div class="stat-number" id="percentage">0%</div>
                                <div class="stat-label">Progress</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Grammar Section -->
                <div class="content-section" id="grammarSection">
                    <div class="grammar-section">
                        <div class="section-title">
                            <i class="fas fa-language"></i>
                            <h2>Grammar Focus - Past Simple Tense</h2>
                        </div>

                        <div class="grammar-theme">
                            <h3><i class="fas fa-magic"></i> Past Simple Tense</h3>
                            <div class="grammar-explanation">
                                The Past Simple tense is used to talk about completed actions in the past. We use it for actions that happened at a specific time in the past or for past habits. Regular verbs add '-ed' (invent ‚Üí invented), while irregular verbs have special forms (wear ‚Üí wore).
                            </div>
                            <div class="grammar-examples">
                                <div class="grammar-example">
                                    <div class="example-icon"><i class="fas fa-star"></i></div>
                                    <div><strong>Whitcomb L. Judson invented the zipper in 1893.</strong> (specific time in past)</div>
                                </div>
                                <div class="grammar-example">
                                    <div class="example-icon"><i class="fas fa-star"></i></div>
                                    <div><strong>People wore high shoes with buttons.</strong> (past habit)</div>
                                </div>
                                <div class="grammar-example">
                                    <div class="example-icon"><i class="fas fa-star"></i></div>
                                    <div><strong>They didn't buy many of them.</strong> (negative form)</div>
                                </div>
                            </div>
                        </div>

                        <div id="grammarExercisesContainer"></div>
                        <button class="btn grammar-submit" id="grammarSubmitBtn">
                            <i class="fas fa-paper-plane"></i> Submit Grammar Exercises
                        </button>
                    </div>
                </div>

                <!-- Exercises Section -->
                <div class="content-section" id="exercisesSection">
                    <div class="exercises-section">
                        <div class="section-title">
                            <i class="fas fa-tasks"></i>
                            <h2>Exercises & Practice</h2>
                        </div>
                        <p style="color: var(--gray); margin-bottom: 30px; font-size: 14px;">
                            Complete each exercise category. You have 30 seconds for each question!
                        </p>
                        <div id="exercisesContainer"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Modal -->
    <div class="modal" id="resultsModal">
        <div class="modal-content">
            <h2 style="color: var(--secondary); margin-bottom: 15px;">Exercise Results</h2>
            <div class="result-score" id="finalScore">0/0</div>
            <div class="result-message" id="resultMessage"></div>
            <button class="btn" id="closeResultsBtn" style="width: 180px; margin-top: 20px;">
                <i class="fas fa-check"></i> Continue
            </button>
        </div>
    </div>

    <script>
        // -----------------------------
        // State
        // -----------------------------
        let currentUser = null;
        let currentBook = null;
        let currentUnit = null;

        let speech = null;
        let isReadingAloud = false;

        let skimmingInterval = null;
        let isSkimmingActive = false;
        let skimmingSpeed = 200; // will be set from slider on init

        let foundWords = new Set();
        let exerciseAnswers = {};
        let categoryResults = {};
        let currentTimers = {};
        let currentExerciseState = {};

        let voices = [];
        let selectedVoice = null;

        // -----------------------------
        // Content data
        // -----------------------------
        const unitText = `The zipper is a wonderful invention. How did people ever live without zippers? They are very common, so we forget that they are wonderful. They are very strong, but they open and close very easily. They come in many colors and sizes.

In the 1890s, people in the United States wore high shoes with a long row of buttons. Clothes often had long rows of buttons, too. People wished that clothes were easier to put on and take off.

Whitcomb L. Judson, an engineer from the United States, invented the zipper in 1893. However, his zippers didn't stay closed very well. This was embarrassing, and people didn't buy many of them.

Then Dr. Gideon Sundback from Sweden solved this problem. His zipper stayed closed.

A zipper has three parts: 1. There are dozens of metal or plastic hooks (called teeth) in two rows. 2. These hooks are fastened to two strips of cloth. The cloth strips are flexible. They bend easily. 3. A fastener slides along and joins the hooks together. When it slides the other way, it takes the hooks apart.

Dr. Sundback put the hooks on strips of cloth. The cloth holds all the hooks in place. They don't come apart very easily. This solved the problem of the first zippers.`;

        const vocabulary = [
            { word: "invention", type: "noun", pronunciation: "/…™nÀàv…õn É…ôn/", translation: "ixtiro", definition: "Something that has been invented or created for the first time", example: "The telephone was a revolutionary invention that changed communication." },
            { word: "common", type: "adjective", pronunciation: "/Ààk…ím…ôn/", translation: "keng tarqalgan", definition: "Occurring, found, or done often; prevalent", example: "It's common to see people using smartphones everywhere." },
            { word: "engineer", type: "noun", pronunciation: "/Àå…õnd í…™Ààn…™…ôr/", translation: "muhandis", definition: "A person who designs, builds, or maintains engines, machines, or structures", example: "The civil engineer designed the new bridge." },
            { word: "embarrassing", type: "adjective", pronunciation: "/…™mÀàb√¶r…ôs…™≈ã/", translation: "uyaltiruvchi, noqulay", definition: "Causing embarrassment; awkward", example: "Forgetting someone's name can be embarrassing." },
            { word: "fastened", type: "verb", pronunciation: "/Ààf…ëÀês…ônd/", translation: "mahkamlangan, bog'langan", definition: "Closed or secured firmly", example: "She fastened her seatbelt before driving." },
            { word: "flexible", type: "adjective", pronunciation: "/Ààfl…õks…™b…ôl/", translation: "egiluvchan, moslashuvchan", definition: "Capable of bending easily without breaking", example: "Rubber is a flexible material used in many products." },
            { word: "dozens", type: "noun", pronunciation: "/Ààd åz…ônz/", translation: "o'nlab, ko'plab", definition: "A lot of something (literally 12 or more)", example: "Dozens of people attended the meeting." },
            { word: "wonderful", type: "adjective", pronunciation: "/Ààw ånd…ôf…ôl/", translation: "ajoyib, a'lo", definition: "Extremely good; excellent", example: "We had a wonderful time at the party." },
            { word: "slides", type: "verb", pronunciation: "/sla…™dz/", translation: "sirg'alib harakatlanadi", definition: "Moves smoothly along a surface", example: "The drawer slides open easily." }
        ];

        const collocations = [
            { collocation: "wonderful invention", pronunciation: "/Ààw ånd…ôf…ôl …™nÀàv…õn É…ôn/", translation: "ajoyib ixtiro", definition: "An excellent creation or discovery", example: "The internet is a wonderful invention that connects people worldwide." },
            { collocation: "very common", pronunciation: "/Ààv…õri Ààk…ím…ôn/", translation: "juda keng tarqalgan", definition: "Extremely widespread or frequent", example: "Mobile phones are very common in modern society." },
            { collocation: "stay closed", pronunciation: "/ste…™ kl…ô äzd/", translation: "yopiq turish", definition: "Remain shut or fastened", example: "A good zipper should stay closed when you move." },
            { collocation: "put on", pronunciation: "/p ät …ín/", translation: "kiymoq, kiyintirmoq", definition: "To dress oneself with clothing", example: "It's easy to put on clothes with zippers." },
            { collocation: "take off", pronunciation: "/te…™k …íf/", translation: "echmoq, yechmoq", definition: "To remove clothing", example: "You can take off your jacket quickly with a zipper." }
        ];

        const grammarExercises = [
            { question: "Which sentence uses Past Simple correctly?", options: ["He invent the zipper in 1893.", "He invents the zipper in 1893.", "He invented the zipper in 1893.", "He is inventing the zipper in 1893."], correct: 2 },
            { question: "What is the Past Simple form of 'wear'?", options: ["wears", "wore", "wearing", "weared"], correct: 1 },
            { question: "Which is the negative form in Past Simple?", options: ["People don't buy zippers.", "People didn't bought zippers.", "People didn't buy zippers.", "People doesn't buy zippers."], correct: 2 },
            { question: "Transform to Past Simple: 'He designs machines.'", options: ["He designed machines.", "He is designing machines.", "He designs machines.", "He will design machines."], correct: 0 },
            { question: "Make a question: 'They invented the zipper.'", options: ["Do they invent the zipper?", "Did they invent the zipper?", "Are they inventing the zipper?", "Have they invented the zipper?"], correct: 1 }
        ];

        const definitionExercises = [
            { question: "What does 'invention' mean?", options: ["Something old and traditional", "Something created for the first time", "Something broken", "Something expensive"], correct: 1 },
            { question: "What is the meaning of 'flexible'?", options: ["Very strong and hard", "Easy to bend without breaking", "Always the same shape", "Made of metal"], correct: 1 },
            { question: "Define 'embarrassing'", options: ["Making you feel happy and proud", "Making you feel shy or uncomfortable", "Making you feel angry", "Making you feel tired"], correct: 1 },
            { question: "What does 'common' mean?", options: ["Rare and special", "Found or happening often", "Difficult to find", "Very expensive"], correct: 1 },
            { question: "Define 'fastener'", options: ["Something that opens things", "A device that closes or secures something", "A type of clothing", "A tool for cutting"], correct: 1 }
        ];

        const gapFillingExercises = [
            { question: "Whitcomb L. Judson ______ the zipper in 1893.", options: ["create", "creates", "created", "creating"], correct: 2 },
            { question: "People in the 1890s ______ high shoes with buttons.", options: ["wear", "wears", "wore", "wearing"], correct: 2 },
            { question: "The cloth strips ______ flexible.", options: ["is", "are", "was", "were"], correct: 1 },
            { question: "They ______ many colors and sizes.", options: ["come", "comes", "came", "coming"], correct: 0 },
            { question: "People ______ that clothes were easier to put on.", options: ["wish", "wishes", "wished", "wishing"], correct: 2 }
        ];

        const englishUzbekExercises = [
            { question: "What is the Uzbek translation of 'engineer'?", options: ["o'qituvchi", "shifokor", "muhandis", "doktor"], correct: 2 },
            { question: "'Fastened' in Uzbek is:", options: ["ochiq", "yopiq", "mahkamlangan", "buzilgan"], correct: 2 },
            { question: "Translate 'dozens' to Uzbek:", options: ["bir necha", "o'nlab", "yuzlab", "kam"], correct: 1 },
            { question: "'Flexible' in Uzbek is:", options: ["qattiq", "egiluvchan", "kuchli", "zaif"], correct: 1 },
            { question: "Translate 'invention' to Uzbek:", options: ["topilma", "ixtiro", "kashfiyot", "yaratish"], correct: 1 }
        ];

        const uzbekEnglishExercises = [
            { question: "'Ixtiro' in English is:", options: ["discovery", "invention", "creation", "production"], correct: 1 },
            { question: "'Egiluvchan' translates to:", options: ["strong", "flexible", "hard", "soft"], correct: 1 },
            { question: "'Keng tarqalgan' means:", options: ["rare", "common", "special", "unique"], correct: 1 },
            { question: "'Muhandis' in English is:", options: ["teacher", "doctor", "engineer", "driver"], correct: 2 },
            { question: "'Mahkamlangan' means:", options: ["open", "closed", "fastened", "broken"], correct: 2 }
        ];

        // -----------------------------
        // Helpers
        // -----------------------------
        function escapeHtml(str) {
            return String(str)
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#039;");
        }

        // -----------------------------
        // Init
        // -----------------------------
        document.addEventListener('DOMContentLoaded', () => {
            // UI events
            document.getElementById('group').addEventListener('change', handleGroupChange);
            document.getElementById('loginForm').addEventListener('submit', onLoginSubmit);
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('backToBooksBtn').addEventListener('click', showBooks);
            document.getElementById('closeResultsBtn').addEventListener('click', closeResults);

            document.getElementById('readAloudBtn').addEventListener('click', toggleReadAloud);
            document.getElementById('skimmingBtn').addEventListener('click', toggleSkimming);
            document.getElementById('voiceSelect').addEventListener('change', updateVoice);

            document.getElementById('speedControl').addEventListener('input', updateSpeed);
            document.getElementById('skimmingSpeedControl').addEventListener('input', updateSkimmingSpeed);

            // Tab handlers
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => showTab(btn.dataset.tab, btn));
            });
            document.querySelectorAll('.vocab-tab-btn').forEach(btn => {
                btn.addEventListener('click', () => showVocabTab(btn.dataset.vtab, btn));
            });

            document.getElementById('grammarSubmitBtn').addEventListener('click', submitGrammarExercises);

            // Initial data
            updateLoginTime();
            loadBooks();
            loadVoices();
            updateSkimmingSpeed(); // set skimmingSpeed from slider on load
            updateSpeed(); // ensure UI matches slider

            // Check saved user
            const savedUser = localStorage.getItem('readingPlatformUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showPlatform();
            }

            // Update login time every second
            setInterval(updateLoginTime, 1000);
        });

        // -----------------------------
        // Voices
        // -----------------------------
        function populateVoices() {
            voices = speechSynthesis.getVoices();
            const voiceSelect = document.getElementById('voiceSelect');
            voiceSelect.innerHTML = '<option value="">Select Voice</option>';

            voices.forEach((voice, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${voice.name} (${voice.lang})`;
                voiceSelect.appendChild(option);
            });

            const defaultVoice =
                voices.find(v => (v.lang || "").startsWith('en-US')) ||
                voices.find(v => (v.lang || "").startsWith('en-GB')) ||
                voices.find(v => (v.lang || "").startsWith('en'));

            if (defaultVoice) {
                const idx = voices.indexOf(defaultVoice);
                voiceSelect.value = String(idx);
                selectedVoice = voices[idx];
            }
        }

        function loadVoices() {
            if (!('speechSynthesis' in window)) return;

            // Some browsers only fire onvoiceschanged; some already have voices.
            speechSynthesis.onvoiceschanged = () => populateVoices();
            populateVoices();

            // fallback refresh
            setTimeout(populateVoices, 500);
            setTimeout(populateVoices, 1500);
        }

        // -----------------------------
        // Login time
        // -----------------------------
        function updateLoginTime() {
            const now = new Date();
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            document.getElementById('loginTime').value = now.toLocaleDateString('en-US', options);
        }

        function handleGroupChange() {
            const groupSelect = document.getElementById('group');
            const otherContainer = document.getElementById('otherGroupContainer');
            otherContainer.style.display = groupSelect.value === 'Others' ? 'block' : 'none';
        }

        function onLoginSubmit(e) {
            e.preventDefault();

            const groupSelect = document.getElementById('group');
            let groupValue = groupSelect.value;

            if (groupValue === 'Others') {
                const otherGroup = document.getElementById('otherGroup').value;
                if (!otherGroup.trim()) {
                    alert('Please specify your group');
                    return;
                }
                groupValue = otherGroup.trim();
            }

            currentUser = {
                name: document.getElementById('name').value.trim(),
                surname: document.getElementById('surname').value.trim(),
                group: groupValue,
                loginTime: document.getElementById('loginTime').value
            };

            if (!currentUser.name || !currentUser.surname || !currentUser.group) {
                alert('Please fill all required fields');
                return;
            }

            localStorage.setItem('readingPlatformUser', JSON.stringify(currentUser));
            showPlatform();
        }

        function showPlatform() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('platformContainer').style.display = 'block';

            document.getElementById('userName').textContent = `${currentUser.name} ${currentUser.surname}`;
            document.getElementById('userGroup').textContent = currentUser.group;
            document.getElementById('userAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('readingPlatformUser');

            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('platformContainer').style.display = 'none';
            document.getElementById('loginForm').reset();
            document.getElementById('otherGroupContainer').style.display = 'none';
            updateLoginTime();

            if (speech && isReadingAloud) speechSynthesis.cancel();
            if (skimmingInterval) clearInterval(skimmingInterval);

            for (let timer in currentTimers) clearInterval(currentTimers[timer]);
            currentTimers = {};
            currentExerciseState = {};
            exerciseAnswers = {};
            categoryResults = {};

            // reset reading UI
            isReadingAloud = false;
            isSkimmingActive = false;
            document.getElementById('readAloudBtn').classList.remove('active');
            document.getElementById('skimmingBtn').classList.remove('active');
            document.getElementById('skimmingProgress').style.width = '0%';
        }

        // -----------------------------
        // Books
        // -----------------------------
        function loadBooks() {
            const booksGrid = document.getElementById('booksGrid');
            const books = [
                {
                    title: "Thoughts and Notions",
                    description: "Improve your reading skills with interesting texts, vocabulary, grammar, and exercises.",
                    status: "available",
                    icon: "fas fa-brain",
                    color: "linear-gradient(135deg, #667eea 0%, #764ba2 100%)"
                },
                {
                    title: "Reading Explorer",
                    description: "Coming Soon - Advanced reading comprehension and critical thinking skills.",
                    status: "soon",
                    icon: "fas fa-binoculars",
                    color: "linear-gradient(135deg, #c3cfe2 0%, #a5b4fc 100%)"
                },
                {
                    title: "Grammar in Use",
                    description: "Coming Soon - Practical grammar exercises and real-life examples.",
                    status: "soon",
                    icon: "fas fa-language",
                    color: "linear-gradient(135deg, #c3cfe2 0%, #a5b4fc 100%)"
                },
                {
                    title: "Vocabulary Builder",
                    description: "Coming Soon - Expand your vocabulary with thematic word lists.",
                    status: "soon",
                    icon: "fas fa-book",
                    color: "linear-gradient(135deg, #c3cfe2 0%, #a5b4fc 100%)"
                }
            ];

            booksGrid.innerHTML = books.map(book => `
                <div class="book-card ${book.status === 'soon' ? 'coming-soon' : ''}"
                     data-status="${book.status}">
                    <div class="book-cover" style="background: ${book.color};">
                        <i class="${book.icon}"></i>
                    </div>
                    <div class="book-info">
                        <h3>${book.title}</h3>
                        <p>${book.description}</p>
                        <span class="status-badge ${book.status === 'available' ? 'available' : 'soon'}">
                            ${book.status === 'available' ? 'Available Now' : 'Coming Soon'}
                        </span>
                    </div>
                </div>
            `).join('');

            booksGrid.querySelectorAll('.book-card').forEach(card => {
                const status = card.getAttribute('data-status');
                card.addEventListener('click', () => {
                    if (status === 'available') openBook();
                    else showComingSoon();
                });
            });
        }

        function showComingSoon() {
            alert('This book will be available soon! Currently working on "Thoughts and Notions".');
        }

        function openBook() {
            currentBook = "Thoughts and Notions";

            document.getElementById('booksSection').style.display = 'none';
            document.getElementById('unitView').style.display = 'block';

            // reset loaded sections so they load when tab is opened
            document.getElementById('vocabularyGrid').innerHTML = '';
            document.getElementById('collocationsGrid').innerHTML = '';
            document.getElementById('grammarExercisesContainer').innerHTML = '';
            document.getElementById('exercisesContainer').innerHTML = '';

            loadUnit("1.1");

            // activate Reading tab (button + section)
            const readingBtn = document.querySelector('.tab-btn[data-tab="reading"]');
            showTab('reading', readingBtn);
        }

        function showBooks() {
            document.getElementById('booksSection').style.display = 'block';
            document.getElementById('unitView').style.display = 'none';

            if (speech && isReadingAloud) {
                speechSynthesis.cancel();
                document.getElementById('readAloudBtn').classList.remove('active');
                isReadingAloud = false;
            }

            if (skimmingInterval) {
                clearInterval(skimmingInterval);
                document.getElementById('skimmingBtn').classList.remove('active');
                isSkimmingActive = false;
                resetText();
                document.getElementById('skimmingProgress').style.width = '0%';
            }

            for (let timer in currentTimers) clearInterval(currentTimers[timer]);
            currentTimers = {};
            currentExerciseState = {};
        }

        // -----------------------------
        // Tabs
        // -----------------------------
        function showTab(tabName, btnEl) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            if (btnEl) btnEl.classList.add('active');

            document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
            const target = document.getElementById(tabName + 'Section');
            if (target) target.classList.add('active');

            if (tabName === 'vocabulary' && !document.getElementById('vocabularyGrid').innerHTML.trim()) {
                loadVocabulary();
                loadCollocations();
                updateStats();
            } else if (tabName === 'grammar' && !document.getElementById('grammarExercisesContainer').innerHTML.trim()) {
                loadGrammarExercises();
            } else if (tabName === 'exercises' && !document.getElementById('exercisesContainer').innerHTML.trim()) {
                loadExercises();
            }
        }

        function showVocabTab(tabName, btnEl) {
            document.querySelectorAll('.vocab-tab-btn').forEach(btn => btn.classList.remove('active'));
            if (btnEl) btnEl.classList.add('active');

            document.querySelectorAll('.vocab-tab-content').forEach(tab => tab.classList.remove('active'));
            const target = document.getElementById(tabName + 'Tab');
            if (target) target.classList.add('active');
        }

        // -----------------------------
        // Unit
        // -----------------------------
        function loadUnit(unitId) {
            currentUnit = unitId;
            resetText();
        }

        function resetText() {
            const readingText = document.getElementById('readingText');
            readingText.innerHTML = unitText.split('\n\n').map(paragraph =>
                `<div class="text-line">${escapeHtml(paragraph)}</div>`
            ).join('');
        }

        // -----------------------------
        // Vocabulary
        // -----------------------------
        function loadVocabulary() {
            const vocabularyGrid = document.getElementById('vocabularyGrid');
            vocabularyGrid.innerHTML = vocabulary.map((word, index) => `
                <div class="vocab-card" id="vocabCard${index}">
                    <div class="vocab-word-header">
                        <div>
                            <div class="vocab-word">${escapeHtml(word.word)}</div>
                            <div class="vocab-pronunciation">${escapeHtml(word.pronunciation)}</div>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <span class="vocab-type">${escapeHtml(word.type)}</span>
                            <button class="pronunciation-btn" type="button" data-say="${escapeHtml(word.word)}">
                                <i class="fas fa-volume-up"></i>
                            </button>
                        </div>
                    </div>
                    <div class="vocab-hint">
                        <i class="fas fa-lightbulb"></i> Click to reveal details
                    </div>
                    <div class="vocab-translation">
                        <i class="fas fa-exchange-alt"></i> <strong>Translation:</strong> ${escapeHtml(word.translation)}
                    </div>
                    <div class="vocab-definition">
                        <i class="fas fa-book"></i> <strong>Definition:</strong> ${escapeHtml(word.definition)}
                    </div>
                    <div class="vocab-example">
                        <i class="fas fa-comment"></i> <strong>Example:</strong> ${escapeHtml(word.example)}
                    </div>
                </div>
            `).join('');

            vocabularyGrid.querySelectorAll('.vocab-card').forEach((card, idx) => {
                card.addEventListener('click', () => showWordDetails(idx, 'vocabulary'));
            });

            vocabularyGrid.querySelectorAll('.pronunciation-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    pronounceWord(btn.getAttribute('data-say') || '', btn);
                });
            });
        }

        function loadCollocations() {
            const collocationsGrid = document.getElementById('collocationsGrid');
            collocationsGrid.innerHTML = collocations.map((item, index) => `
                <div class="vocab-card" id="collocationCard${index}">
                    <div class="vocab-word-header">
                        <div>
                            <div class="vocab-word">${escapeHtml(item.collocation)}</div>
                            <div class="vocab-pronunciation">${escapeHtml(item.pronunciation)}</div>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <span class="vocab-type" style="background: #f59e0b;">Collocation</span>
                            <button class="pronunciation-btn" type="button" data-say="${escapeHtml(item.collocation)}">
                                <i class="fas fa-volume-up"></i>
                            </button>
                        </div>
                    </div>
                    <div class="vocab-hint">
                        <i class="fas fa-lightbulb"></i> Click to reveal details
                    </div>
                    <div class="vocab-translation">
                        <i class="fas fa-exchange-alt"></i> <strong>Translation:</strong> ${escapeHtml(item.translation)}
                    </div>
                    <div class="vocab-definition">
                        <i class="fas fa-book"></i> <strong>Definition:</strong> ${escapeHtml(item.definition)}
                    </div>
                    <div class="vocab-example">
                        <i class="fas fa-comment"></i> <strong>Example:</strong> ${escapeHtml(item.example)}
                    </div>
                </div>
            `).join('');

            collocationsGrid.querySelectorAll('.vocab-card').forEach((card, idx) => {
                card.addEventListener('click', () => showWordDetails(idx, 'collocations'));
            });

            collocationsGrid.querySelectorAll('.pronunciation-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    pronounceWord(btn.getAttribute('data-say') || '', btn);
                });
            });
        }

        function showWordDetails(index, type) {
            let card;
            if (type === 'vocabulary') {
                card = document.getElementById(`vocabCard${index}`);
                foundWords.add(`vocab-${index}`);
            } else {
                card = document.getElementById(`collocationCard${index}`);
                foundWords.add(`colloc-${index}`);
            }
            if (!card) return;

            const translation = card.querySelector('.vocab-translation');
            const definition = card.querySelector('.vocab-definition');
            const example = card.querySelector('.vocab-example');

            const isHidden = !translation.style.display || translation.style.display === 'none';

            if (isHidden) {
                translation.style.display = 'block';
                definition.style.display = 'block';
                example.style.display = 'block';
                card.classList.add('found');
                card.style.animation = 'none';
                setTimeout(() => { card.style.animation = 'pulse 0.5s ease'; }, 10);
            } else {
                translation.style.display = 'none';
                definition.style.display = 'none';
                example.style.display = 'none';
                card.classList.remove('found');
                if (type === 'vocabulary') foundWords.delete(`vocab-${index}`);
                else foundWords.delete(`colloc-${index}`);
            }

            updateStats();
        }

        function pronounceWord(text, btnEl) {
            if (!text) return;
            if (!('speechSynthesis' in window)) return;

            // avoid queue stacking
            speechSynthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            if (selectedVoice) utterance.voice = selectedVoice;
            utterance.rate = 0.8;
            utterance.pitch = 1;
            utterance.volume = 1;

            speechSynthesis.speak(utterance);

            if (btnEl) {
                btnEl.innerHTML = '<i class="fas fa-volume-up fa-spin"></i>';
                setTimeout(() => { btnEl.innerHTML = '<i class="fas fa-volume-up"></i>'; }, 900);
            }
        }

        function updateStats() {
            const found = foundWords.size;
            const total = vocabulary.length + collocations.length;
            const pct = total > 0 ? Math.round((found / total) * 100) : 0;

            document.getElementById('foundCount').textContent = found;
            document.getElementById('totalCount').textContent = total;
            document.getElementById('percentage').textContent = `${pct}%`;
        }

        // -----------------------------
        // Grammar
        // -----------------------------
        function loadGrammarExercises() {
            const container = document.getElementById('grammarExercisesContainer');
            container.innerHTML = `
                <div style="margin-top: 25px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                    <h3 style="color: var(--secondary); margin-bottom: 20px; display: flex; align-items: center; gap: 12px; font-size: 1.2rem;">
                        <i class="fas fa-pen"></i> Grammar Practice (${grammarExercises.length} Questions)
                    </h3>
                    <div class="exercise-list" id="grammarExerciseList">
                        ${grammarExercises.map((exercise, index) => `
                            <div class="exercise-item">
                                <div class="question-header">
                                    <div class="question-number">Question ${index + 1}/${grammarExercises.length}</div>
                                </div>
                                <div class="question-text">${escapeHtml(exercise.question)}</div>
                                <div class="options-grid">
                                    ${exercise.options.map((option, optIndex) => `
                                        <div class="option" data-gq="${index}" data-go="${optIndex}" id="grammarEx${index}opt${optIndex}">
                                            <div class="option-letter">${String.fromCharCode(65 + optIndex)}</div>
                                            <div>${escapeHtml(option)}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            // click handlers
            container.querySelectorAll('.option[data-gq]').forEach(opt => {
                opt.addEventListener('click', () => {
                    const q = parseInt(opt.getAttribute('data-gq'), 10);
                    const o = parseInt(opt.getAttribute('data-go'), 10);
                    selectGrammarAnswer(q, o);
                });
            });

            showGrammarQuestion(0);
        }

        function showGrammarQuestion(index) {
            const questions = document.querySelectorAll('#grammarExerciseList .exercise-item');
            questions.forEach(q => q.classList.remove('active'));
            if (questions[index]) questions[index].classList.add('active');
        }

        function selectGrammarAnswer(exerciseIndex, optionIndex) {
            const optionEl = document.getElementById(`grammarEx${exerciseIndex}opt${optionIndex}`);
            if (!optionEl) return;

            const question = optionEl.closest('.exercise-item');
            question.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
            optionEl.classList.add('selected');

            if (!exerciseAnswers.grammar) exerciseAnswers.grammar = {};
            exerciseAnswers.grammar[exerciseIndex] = optionIndex;

            setTimeout(() => {
                if (exerciseIndex < grammarExercises.length - 1) showGrammarQuestion(exerciseIndex + 1);
            }, 500);
        }

        async function submitGrammarExercises() {
            const btn = document.getElementById('grammarSubmitBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';

            let score = 0;
            const total = grammarExercises.length;

            if (!exerciseAnswers.grammar) exerciseAnswers.grammar = {};

            grammarExercises.forEach((exercise, index) => {
                const answer = exerciseAnswers.grammar[index];
                const correct = exercise.correct;

                for (let i = 0; i < 4; i++) {
                    const option = document.getElementById(`grammarEx${index}opt${i}`);
                    if (!option) continue;
                    option.classList.remove('correct', 'incorrect');
                    if (i === correct) option.classList.add('correct');
                    else if (answer === i && answer !== correct) option.classList.add('incorrect');
                }

                if (answer === correct) score++;
            });

            const pct = Math.round((score / total) * 100);

            const resultDiv = document.createElement('div');
            resultDiv.className = `exercise-result ${pct >= 60 ? 'success' : 'error'}`;
            resultDiv.style.display = 'flex';
            resultDiv.innerHTML = `
                <div class="result-text">${score}/${total} correct (${pct}%)</div>
                <div>${pct >= 60 ? '‚úÖ Good job!' : '‚ùå Try again!'}</div>
            `;

            const existingResult = document.querySelector('#grammarExercisesContainer .exercise-result');
            if (existingResult) existingResult.remove();

            const grammarList = document.getElementById('grammarExerciseList');
            grammarList.parentNode.insertBefore(resultDiv, grammarList.nextSibling);

            try {
                await fetch('/api/telegram', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        studentName: `${currentUser?.name || ''} ${currentUser?.surname || ''}`.trim(),
                        exerciseType: 'Grammar Exercises',
                        score,
                        totalQuestions: total,
                        percentage: pct,
                        unit: '1.1',
                        book: currentBook,
                        group: currentUser?.group || '',
                        timestamp: new Date().toISOString()
                    })
                });
            } catch (error) {
                console.log('Telegram notification error:', error);
            }

            categoryResults.grammar = { score, total, percentage: pct };

            setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Grammar Exercises';
            }, 1200);
        }

        // -----------------------------
        // Exercises
        // -----------------------------
        function loadExercises() {
            const exercisesContainer = document.getElementById('exercisesContainer');

            const exerciseCategories = [
                { id: 'definition', title: "Definition Exercises", icon: "fas fa-book", exercises: definitionExercises },
                { id: 'gap', title: "Gap Filling", icon: "fas fa-edit", exercises: gapFillingExercises },
                { id: 'english_uzbek', title: "English ‚Üí Uzbek", icon: "fas fa-arrow-right", exercises: englishUzbekExercises },
                { id: 'uzbek_english', title: "Uzbek ‚Üí English", icon: "fas fa-arrow-left", exercises: uzbekEnglishExercises }
            ];

            exercisesContainer.innerHTML = exerciseCategories.map(category => `
                <div class="exercise-category" id="${category.id}_category">
                    <div class="category-header">
                        <div class="category-title">
                            <div class="category-icon"><i class="${category.icon}"></i></div>
                            <div class="category-info">
                                <h3>${escapeHtml(category.title)}</h3>
                                <p>${category.exercises.length} questions ‚Ä¢ 30 seconds each</p>
                            </div>
                        </div>
                        <div class="exercise-timer" id="timer_${category.id}">
                            <i class="fas fa-clock"></i>
                            <span id="time_${category.id}">30s</span>
                        </div>
                    </div>

                    <div class="exercise-list" id="list_${category.id}">
                        ${category.exercises.map((exercise, exIndex) => `
                            <div class="exercise-item" id="${category.id}_q${exIndex}">
                                <div class="question-header">
                                    <div class="question-number">Question ${exIndex + 1}/${category.exercises.length}</div>
                                </div>
                                <div class="question-text">${escapeHtml(exercise.question)}</div>
                                <div class="options-grid">
                                    ${exercise.options.map((option, optIndex) => `
                                        <div class="option" id="${category.id}_${exIndex}_${optIndex}" data-cid="${category.id}" data-q="${exIndex}" data-o="${optIndex}">
                                            <div class="option-letter">${String.fromCharCode(65 + optIndex)}</div>
                                            <div>${escapeHtml(option)}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <div class="exercise-navigation" id="nav_${category.id}">
                        <button class="nav-btn" id="prev_${category.id}" data-nav="prev" data-cid="${category.id}">
                            <i class="fas fa-arrow-left"></i> Previous
                        </button>
                        <div class="progress-indicator" id="progress_${category.id}">
                            ${category.exercises.map((_, idx) => `<div class="progress-dot" id="dot_${category.id}_${idx}"></div>`).join('')}
                        </div>
                        <button class="nav-btn" id="next_${category.id}" data-nav="next" data-cid="${category.id}">
                            Next <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>

                    <div class="exercise-result" id="result_${category.id}"></div>

                    <button class="btn category-submit" id="submit_${category.id}" data-submit="${category.id}">
                        <i class="fas fa-paper-plane"></i> Submit ${escapeHtml(category.title)}
                    </button>
                </div>
            `).join('');

            // option click handlers
            exercisesContainer.querySelectorAll('.option[data-cid]').forEach(opt => {
                opt.addEventListener('click', () => {
                    const cid = opt.getAttribute('data-cid');
                    const q = parseInt(opt.getAttribute('data-q'), 10);
                    const o = parseInt(opt.getAttribute('data-o'), 10);
                    selectExerciseAnswer(cid, q, o);
                });
            });

            // nav handlers
            exercisesContainer.querySelectorAll('button[data-nav]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const cid = btn.getAttribute('data-cid');
                    if (btn.getAttribute('data-nav') === 'prev') prevQuestion(cid);
                    else nextQuestion(cid);
                });
            });

            // submit handlers
            exercisesContainer.querySelectorAll('button[data-submit]').forEach(btn => {
                btn.addEventListener('click', () => submitCategory(btn.getAttribute('data-submit')));
            });

            // init categories
            exerciseCategories.forEach(category => initializeCategory(category.id, category.exercises.length));
        }

        function initializeCategory(categoryId, totalQuestions) {
            if (!currentExerciseState[categoryId]) {
                currentExerciseState[categoryId] = {
                    currentQuestion: 0,
                    answers: {},
                    timer: 30,
                    timerInterval: null,
                    completed: false
                };
            }
            showQuestion(categoryId, 0);
            startTimer(categoryId);
            updateNavigation(categoryId, totalQuestions);
        }

        function getTotalQuestions(categoryId) {
            switch (categoryId) {
                case 'definition': return definitionExercises.length;
                case 'gap': return gapFillingExercises.length;
                case 'english_uzbek': return englishUzbekExercises.length;
                case 'uzbek_english': return uzbekEnglishExercises.length;
                default: return 0;
            }
        }

        function showQuestion(categoryId, questionIndex) {
            const total = getTotalQuestions(categoryId);

            for (let i = 0; i < total; i++) {
                const q = document.getElementById(`${categoryId}_q${i}`);
                if (q) q.classList.remove('active');
            }

            const current = document.getElementById(`${categoryId}_q${questionIndex}`);
            if (current) current.classList.add('active');

            updateProgressDots(categoryId, questionIndex);
            updateNavigation(categoryId, total);
            resetTimer(categoryId);
        }

        function updateProgressDots(categoryId, currentIndex) {
            const total = getTotalQuestions(categoryId);
            for (let i = 0; i < total; i++) {
                const dot = document.getElementById(`dot_${categoryId}_${i}`);
                if (!dot) continue;

                dot.classList.remove('active', 'answered');

                if (i === currentIndex) dot.classList.add('active');
                if (currentExerciseState[categoryId]?.answers[i] !== undefined) dot.classList.add('answered');
            }
        }

        // ‚úÖ FIXED: next button id used to be wrong in your code (category.id)
        function updateNavigation(categoryId, totalQuestions) {
            const state = currentExerciseState[categoryId];
            const current = state?.currentQuestion || 0;

            const prevBtn = document.getElementById(`prev_${categoryId}`);
            const nextBtn = document.getElementById(`next_${categoryId}`);

            if (prevBtn) prevBtn.disabled = current === 0;
            if (nextBtn) nextBtn.disabled = current === totalQuestions - 1;
        }

        function startTimer(categoryId) {
            const state = currentExerciseState[categoryId];
            if (!state || state.completed) return;

            if (state.timerInterval) clearInterval(state.timerInterval);

            state.timer = 30;
            updateTimerDisplay(categoryId);

            state.timerInterval = setInterval(() => {
                state.timer--;
                updateTimerDisplay(categoryId);

                if (state.timer <= 0) {
                    clearInterval(state.timerInterval);

                    if (state.answers[state.currentQuestion] === undefined) {
                        state.answers[state.currentQuestion] = -1;

                        const total = getTotalQuestions(categoryId);
                        if (state.currentQuestion < total - 1) {
                            state.currentQuestion++;
                            showQuestion(categoryId, state.currentQuestion);
                            startTimer(categoryId);
                        }
                    }
                }
            }, 1000);

            currentTimers[categoryId] = state.timerInterval;
        }

        function updateTimerDisplay(categoryId) {
            const state = currentExerciseState[categoryId];
            if (!state) return;

            const timerElement = document.getElementById(`time_${categoryId}`);
            const timerContainer = document.getElementById(`timer_${categoryId}`);

            if (timerElement) timerElement.textContent = `${state.timer}s`;

            if (timerContainer) {
                timerContainer.className = 'exercise-timer';
                if (state.timer <= 10) timerContainer.classList.add('timer-warning');
                if (state.timer <= 5) timerContainer.classList.add('timer-critical');
            }
        }

        function resetTimer(categoryId) {
            const state = currentExerciseState[categoryId];
            if (!state || state.completed) return;
            state.timer = 30;
            updateTimerDisplay(categoryId);
        }

        function prevQuestion(categoryId) {
            const state = currentExerciseState[categoryId];
            if (!state || state.currentQuestion === 0) return;

            state.currentQuestion--;
            showQuestion(categoryId, state.currentQuestion);
            startTimer(categoryId);
        }

        function nextQuestion(categoryId) {
            const state = currentExerciseState[categoryId];
            const total = getTotalQuestions(categoryId);

            if (!state || state.currentQuestion >= total - 1) return;

            state.currentQuestion++;
            showQuestion(categoryId, state.currentQuestion);
            startTimer(categoryId);
        }

        function selectExerciseAnswer(categoryId, questionIndex, optionIndex) {
            const state = currentExerciseState[categoryId];
            if (!state || state.completed) return;

            state.answers[questionIndex] = optionIndex;
            updateProgressDots(categoryId, state.currentQuestion);

            const questionElement = document.getElementById(`${categoryId}_q${questionIndex}`);
            if (questionElement) {
                questionElement.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
                const selectedOption = document.getElementById(`${categoryId}_${questionIndex}_${optionIndex}`);
                if (selectedOption) selectedOption.classList.add('selected');
            }

            setTimeout(() => {
                const total = getTotalQuestions(categoryId);
                if (state.currentQuestion < total - 1) {
                    state.currentQuestion++;
                    showQuestion(categoryId, state.currentQuestion);
                    startTimer(categoryId);
                }
            }, 900);
        }

        async function submitCategory(categoryId) {
            const btn = document.getElementById(`submit_${categoryId}`);
            const resultDiv = document.getElementById(`result_${categoryId}`);

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';

            let exercises = [];
            switch (categoryId) {
                case 'definition': exercises = definitionExercises; break;
                case 'gap': exercises = gapFillingExercises; break;
                case 'english_uzbek': exercises = englishUzbekExercises; break;
                case 'uzbek_english': exercises = uzbekEnglishExercises; break;
            }

            const total = exercises.length;
            const state = currentExerciseState[categoryId];
            if (!state) return;

            let score = 0;

            exercises.forEach((exercise, index) => {
                const answer = state.answers[index];
                const correct = exercise.correct;

                for (let i = 0; i < 4; i++) {
                    const option = document.getElementById(`${categoryId}_${index}_${i}`);
                    if (!option) continue;
                    option.classList.remove('correct', 'incorrect');
                    if (i === correct) option.classList.add('correct');
                    else if (answer === i && answer !== correct) option.classList.add('incorrect');
                }

                if (answer === correct) score++;
            });

            const pct = Math.round((score / total) * 100);

            resultDiv.className = `exercise-result ${pct >= 60 ? 'success' : 'error'}`;
            resultDiv.style.display = 'flex';
            resultDiv.innerHTML = `
                <div class="result-text">${score}/${total} correct (${pct}%)</div>
                <div>${pct >= 60 ? '‚úÖ Well done!' : '‚ùå Review and try again!'}</div>
            `;

            try {
                await fetch('/api/telegram', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        studentName: `${currentUser?.name || ''} ${currentUser?.surname || ''}`.trim(),
                        exerciseType: getCategoryName(categoryId),
                        score,
                        totalQuestions: total,
                        percentage: pct,
                        unit: '1.1',
                        book: currentBook,
                        group: currentUser?.group || '',
                        timestamp: new Date().toISOString(),
                        timePerQuestion: '30 seconds'
                    })
                });
            } catch (error) {
                console.log('Telegram notification error:', error);
            }

            categoryResults[categoryId] = { score, total, percentage: pct };

            setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit ' + getCategoryName(categoryId);
            }, 1200);
        }

        function getCategoryName(categoryId) {
            switch (categoryId) {
                case 'definition': return 'Definition Exercises';
                case 'gap': return 'Gap Filling';
                case 'english_uzbek': return 'English ‚Üí Uzbek';
                case 'uzbek_english': return 'Uzbek ‚Üí English';
                default: return 'Exercises';
            }
        }

        // -----------------------------
        // Voice selection
        // -----------------------------
        function updateVoice() {
            const voiceSelect = document.getElementById('voiceSelect');
            const voiceIndex = parseInt(voiceSelect.value, 10);
            selectedVoice = (!isNaN(voiceIndex) && voices[voiceIndex]) ? voices[voiceIndex] : null;
        }

        // -----------------------------
        // Read aloud
        // -----------------------------
        function toggleReadAloud() {
            const btn = document.getElementById('readAloudBtn');

            if (isReadingAloud) {
                speechSynthesis.cancel();
                btn.classList.remove('active');
                isReadingAloud = false;
                return;
            }

            if (!('speechSynthesis' in window)) {
                alert('Text-to-speech is not supported in your browser. Please try Chrome or Edge.');
                return;
            }

            speechSynthesis.cancel();
            speech = new SpeechSynthesisUtterance(unitText);

            if (selectedVoice) speech.voice = selectedVoice;

            const speedValue = parseInt(document.getElementById('speedControl').value, 10);
            speech.rate = speedValue / 2.5;
            speech.pitch = 1;
            speech.volume = 1;

            speech.onend = () => {
                btn.classList.remove('active');
                isReadingAloud = false;
            };
            speech.onerror = () => {
                btn.classList.remove('active');
                isReadingAloud = false;
            };

            speechSynthesis.speak(speech);
            btn.classList.add('active');
            isReadingAloud = true;
        }

        function updateSpeed() {
            const speed = parseInt(document.getElementById('speedControl').value, 10);
            document.getElementById('speedValue').textContent = `${speed}x`;

            if (speech && isReadingAloud) {
                speechSynthesis.cancel();
                speech.rate = speed / 2.5;
                speechSynthesis.speak(speech);
            }
        }

        // -----------------------------
        // Skimming
        // -----------------------------
        function updateSkimmingSpeed() {
            const speed = parseInt(document.getElementById('skimmingSpeedControl').value, 10);
            document.getElementById('skimmingSpeedValue').textContent = `${speed}x`;

            skimmingSpeed = 1000 / Math.max(1, speed);

            if (isSkimmingActive) {
                toggleSkimming();
                setTimeout(() => toggleSkimming(), 120);
            }
        }

        function toggleSkimming() {
            const btn = document.getElementById('skimmingBtn');
            const progressBar = document.getElementById('skimmingProgress');
            const textContainer = document.getElementById('readingText');

            if (isSkimmingActive) {
                clearInterval(skimmingInterval);
                skimmingInterval = null;
                btn.classList.remove('active');
                isSkimmingActive = false;
                resetText();
                progressBar.style.width = '0%';
                return;
            }

            btn.classList.add('active');
            isSkimmingActive = true;

            const originalText = unitText; // keep stable source
            let currentPosition = 0;
            const totalLength = originalText.length;

            skimmingInterval = setInterval(() => {
                if (currentPosition >= totalLength) {
                    clearInterval(skimmingInterval);
                    skimmingInterval = null;
                    btn.classList.remove('active');
                    isSkimmingActive = false;
                    return;
                }

                const visibleText = originalText.substring(0, currentPosition);
                const hiddenText = originalText.substring(currentPosition);

                // simple skimming view (preserves line breaks)
                textContainer.innerHTML = `
                    <div style="white-space: pre-wrap; font-family: 'Roboto Slab', serif;">
                        ${escapeHtml(visibleText)}<span class="skimming-active">${escapeHtml(hiddenText)}</span>
                    </div>
                `;

                const progress = (currentPosition / totalLength) * 100;
                progressBar.style.width = `${progress}%`;

                currentPosition += Math.max(1, Math.floor(totalLength / 500));
            }, skimmingSpeed);
        }

        // -----------------------------
        // Modal
        // -----------------------------
        function closeResults() {
            document.getElementById('resultsModal').style.display = 'none';
        }
    </script>
</body>
</html>
